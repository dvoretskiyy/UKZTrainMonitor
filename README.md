# UKZ Train Monitor Bot

**üöÇ –†–æ–±–æ—á–∞ –≤–µ—Ä—Å—ñ—è: [@TrainsMonitorBot](https://t.me/TrainsMonitorBot)**

Telegram-–±–æ—Ç –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∫–≤–∏—Ç–∫—ñ–≤ –Ω–∞ –ø–æ—Ç—è–≥–∏ –£–∫—Ä–∑–∞–ª—ñ–∑–Ω–∏—Ü—ñ –∑ –≥—Ä—É–ø–æ–≤–∏–º–∏ –¥–∑–≤—ñ–Ω–∫–∞–º–∏ —á–µ—Ä–µ–∑ Pyrogram.

## üí° –ü–µ—Ä–µ–¥—ñ—Å—Ç–æ—Ä—ñ—è

–í—Å–µ –ø–æ—á–∞–ª–æ—Å—è –∑ –ø—Ä–æ—Å—Ç–æ—ó –ø—Ä–æ–±–ª–µ–º–∏ - –º–µ–Ω—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–ª–æ –∑–ª–æ–≤–∏—Ç–∏ –∫–≤–∏—Ç–∫–∏ –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç. –ö–≤–∏—Ç–∫–∏ –∑'—è–≤–ª—è–ª–∏—Å—è –≤–∏–ø–∞–¥–∫–æ–≤–æ —ñ —Ä–æ–∑–±–∏—Ä–∞–ª–∏—Å—å –∑–∞ –ª—ñ—á–µ–Ω—ñ —Ö–≤–∏–ª–∏–Ω–∏. –Ø –ø–æ—Å—Ç—ñ–π–Ω–æ –æ–Ω–æ–≤–ª—é–≤–∞–≤ —Å—Ç–æ—Ä—ñ–Ω–∫—É booking.uz.gov.ua, –∞–ª–µ —Ç–∞–∫ —ñ –Ω–µ –∑–º—ñ–≥ –≤—á–∞—Å–Ω–æ —ó—Ö —Å–ø—ñ–π–º–∞—Ç–∏.

–ü—ñ—Å–ª—è –¥–µ–∫—ñ–ª—å–∫–æ—Ö –Ω–µ–≤–¥–∞–ª–∏—Ö —Å–ø—Ä–æ–± —è –≤–∏—Ä—ñ—à–∏–≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏ —Ü–µ–π –ø—Ä–æ—Ü–µ—Å. –¢–∞–∫ –∑'—è–≤–∏–≤—Å—è —Ü–µ–π –±–æ—Ç, —è–∫–∏–π:
- **–ú–æ–Ω—ñ—Ç–æ—Ä–∏—Ç—å –∫–≤–∏—Ç–∫–∏ 24/7** –±–µ–∑ –≤–∞—à–æ—ó —É—á–∞—Å—Ç—ñ
- **–ú–∏—Ç—Ç—î–≤–æ —Å–ø–æ–≤—ñ—â–∞—î** –ø—Ä–∏ –ø–æ—è–≤—ñ –≤—ñ–ª—å–Ω–∏—Ö –º—ñ—Å—Ü—å
- **–î–∑–≤–æ–Ω–∏—Ç—å –≤–∞–º** —á–µ—Ä–µ–∑ Telegram, —â–æ–± –≤–∏ —Ç–æ—á–Ω–æ –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏
- **–í—ñ–¥—Å—Ç–µ–∂—É—î –¥–µ–∫—ñ–ª—å–∫–∞ –º–∞—Ä—à—Ä—É—Ç—ñ–≤** –æ–¥–Ω–æ—á–∞—Å–Ω–æ

–¢–µ–ø–µ—Ä —è –Ω–µ –≤—Ç—Ä–∞—á–∞—é –≥–æ–¥–∏–Ω–∏ –Ω–∞ —Ä—É—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏, –∞ –±–æ—Ç —Ä–æ–±–∏—Ç—å —Ü–µ –∑–∞ –º–µ–Ω–µ —ñ –¥–∑–≤–æ–Ω–∏—Ç—å, –∫–æ–ª–∏ –∑'—è–≤–ª—è—é—Ç—å—Å—è –∫–≤–∏—Ç–∫–∏! üéØ

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—î–∫—Ç—É

```
UKZTrainMonitor/
‚îú‚îÄ‚îÄ bot/                       # Telegram –±–æ—Ç
‚îÇ   ‚îú‚îÄ‚îÄ handlers/              # –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ start.py          # /start –∫–æ–º–∞–Ω–¥–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes.py         # –î–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤ (FSM)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ my_routes.py      # –ö–µ—Ä—É–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/            # –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ keyboards.py      # –í—Å—ñ inline/reply –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
‚îÇ   ‚îî‚îÄ‚îÄ states/               # FSM —Å—Ç–∞–Ω–∏
‚îÇ       ‚îî‚îÄ‚îÄ route_states.py   # –°—Ç–∞–Ω–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É
‚îú‚îÄ‚îÄ db/                       # –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö
‚îÇ   ‚îî‚îÄ‚îÄ database.py          # asyncpg –ø—É–ª –ø—ñ–¥–∫–ª—é—á–µ–Ω—å
‚îú‚îÄ‚îÄ services/                # –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ db_service.py       # User/Route/Monitoring —Å–µ—Ä–≤—ñ—Å–∏
‚îÇ   ‚îú‚îÄ‚îÄ monitor.py          # –§–æ–Ω–æ–≤–∏–π –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –∫–≤–∏—Ç–∫—ñ–≤
‚îÇ   ‚îî‚îÄ‚îÄ telegram_caller.py  # –ì—Ä—É–ø–æ–≤—ñ –¥–∑–≤—ñ–Ω–∫–∏ —á–µ—Ä–µ–∑ Pyrogram
‚îú‚îÄ‚îÄ uz_api/                 # UZ API –∫–ª—ñ—î–Ω—Ç
‚îÇ   ‚îî‚îÄ‚îÄ client.py          # UZApiClient
‚îú‚îÄ‚îÄ utils/                  # –£—Ç–∏–ª—ñ—Ç–∏
‚îÇ   ‚îî‚îÄ‚îÄ telegram_logger.py # –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤ Telegram
‚îú‚îÄ‚îÄ config.py              # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
‚îú‚îÄ‚îÄ main.py               # –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É
‚îî‚îÄ‚îÄ requirements.txt      # –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
```

## üöÄ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

### 1. –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
```bash
git clone <repo-url>
cd UKZTrainMonitor
```

### 2. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
```bash
pip install -r requirements.txt
```

### 3. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è PostgreSQL
```bash
# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
createdb ukz_monitor

# –ê–±–æ —á–µ—Ä–µ–∑ psql
psql -U postgres
CREATE DATABASE ukz_monitor;
```

### 4. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è .env
```bash
cp .env.example .env
```

–í—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ `.env`:
```env
BOT_TOKEN=your_bot_token_from_botfather
DATABASE_URL=postgres://postgres:password@localhost/ukz_monitor
NOTIFICATION_ACCOUNT=@YourNotificationBot

# Pyrogram –¥–ª—è –≥—Ä—É–ø–æ–≤–∏—Ö –¥–∑–≤—ñ–Ω–∫—ñ–≤
API_ID=12345678
API_HASH=your_api_hash
PHONE_NUMBER=+380123456789
SESSION_NAME=caller_session

# –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤ Telegram (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
LOGGER_BOT_TOKEN=
LOGGER_CHAT_ID=

# –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
MONITORING_INTERVAL=600
LOG_LEVEL=INFO

# Proxy (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –æ–±—Ö–æ–¥—É –±–ª–æ–∫—É–≤–∞–Ω—å UZ API)
PROXY_ENABLED=false
PROXY_TYPE=http
PROXY_HOST=proxy.example.com
PROXY_PORT=8000
PROXY_USER=username
PROXY_PASS=password
```

### 5. –ü–µ—Ä—à–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è Pyrogram
–ü—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É –≤–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∑ Telegram –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó —Å–µ—Å—ñ—ó.

### 6. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
```bash
python main.py
```

## üîß –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó

- **aiogram 3.7** - Telegram Bot API
- **asyncpg** - PostgreSQL async driver (–±–µ–∑ ORM)
- **pyrogram 2.0** - –ì—Ä—É–ø–æ–≤—ñ –¥–∑–≤—ñ–Ω–∫–∏ (MTProto API)
- **cloudscraper** - –û–±—Ö—ñ–¥ Cloudflare –¥–ª—è UZ API
- **python-dotenv** - –ó–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è

## üìä –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö

### –¢–∞–±–ª–∏—Ü—ñ

**users**
- `id` SERIAL PRIMARY KEY
- `telegram_id` BIGINT UNIQUE
- `username`, `first_name`, `last_name`
- `created_at`, `is_active`

**routes**
- `id` SERIAL PRIMARY KEY
- `user_id` ‚Üí users(id)
- `station_from_id/name`, `station_to_id/name`
- `dates` JSONB (—Å–ø–∏—Å–æ–∫ –¥–∞—Ç)
- `wagon_classes` JSONB (—Å–ø–∏—Å–æ–∫ –∫–ª–∞—Å—ñ–≤)
- `is_active`, `created_at`, `updated_at`

**monitorings**
- `id` SERIAL PRIMARY KEY
- `route_id` ‚Üí routes(id)
- `last_check`, `last_result` JSONB
- `check_count`, `found_tickets`

## üéØ –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ

### 1Ô∏è‚É£ –î–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É
- –ü–æ—à—É–∫ —Å—Ç–∞–Ω—Ü—ñ–π —á–µ—Ä–µ–∑ UZ API
- –í–∏–±—ñ—Ä –¥–∞—Ç (–¥–æ 50 –¥–∞—Ç, –ø–∞–≥—ñ–Ω–∞—Ü—ñ—è –ø–æ 9)
- –î—ñ–∞–ø–∞–∑–æ–Ω–∏ –¥–∞—Ç (+5 –¥–Ω—ñ–≤)
- –í–∏–±—ñ—Ä –∫–ª–∞—Å—ñ–≤ –≤–∞–≥–æ–Ω—ñ–≤ (–õ, –ö, –ü, –°1-–°3)

### 2Ô∏è‚É£ –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
- –§–æ–Ω–æ–≤–∏–π –≤–æ—Ä–∫–µ—Ä –ø–µ—Ä–µ–≤—ñ—Ä—è—î –∫–≤–∏—Ç–∫–∏ –∫–æ–∂–Ω—ñ N —Å–µ–∫—É–Ω–¥
- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫
- –õ–æ–≥—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π

### 3Ô∏è‚É£ –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è
- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram –ø—Ä–∏ –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—ñ –∫–≤–∏—Ç–∫—ñ–≤
- **–ì—Ä—É–ø–æ–≤–∏–π –¥–∑–≤—ñ–Ω–æ–∫** —á–µ—Ä–µ–∑ Pyrogram
- –î–µ—Ç–∞–ª—ñ –ø—Ä–æ –¥–æ—Å—Ç—É–ø–Ω—ñ –º—ñ—Å—Ü—è —Ç–∞ –ø–æ—ó–∑–¥–∏

### 4Ô∏è‚É£ –ö–µ—Ä—É–≤–∞–Ω–Ω—è
- –ü–µ—Ä–µ–≥–ª—è–¥ —Å–ø–∏—Å–∫—É –º–∞—Ä—à—Ä—É—Ç—ñ–≤
- –ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–Ω—è/–≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è
- –í–∏–¥–∞–ª–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤

## üîê –ë–µ–∑–ø–µ–∫–∞

- `.env` —Ñ–∞–π–ª —É `.gitignore`
- Pyrogram session —Ñ–∞–π–ª–∏ –ù–ï –∫–æ–º—ñ—Ç—è—Ç—å—Å—è
- API –∫–ª—é—á—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –∑–º—ñ–Ω–Ω–∏—Ö –æ—Ç–æ—á–µ–Ω–Ω—è

## üìù –õ–æ–≥—É–≤–∞–Ω–Ω—è

- **–ö–æ–Ω—Å–æ–ª—å** - INFO+
- **–§–∞–π–ª** (bot.log) - DEBUG+
- **Telegram** (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ) - INFO+ —á–µ—Ä–µ–∑ –æ–∫—Ä–µ–º–æ–≥–æ –±–æ—Ç–∞

## üõ† –†–æ–∑—Ä–æ–±–∫–∞

### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞
- **–ß–∏—Å—Ç–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞** (handlers ‚Üí services ‚Üí db)
- **asyncpg –±–µ–∑ ORM** (—à–≤–∏–¥—à–µ –∑–∞ SQLAlchemy)
- **Type hints** –ø–æ–≤—Å—é–¥–∏
- **FSM** –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö –¥—ñ–∞–ª–æ–≥—ñ–≤
- **Async/await** –¥–ª—è –≤—Å—ñ—Ö I/O –æ–ø–µ—Ä–∞—Ü—ñ–π

### –ß–æ–º—É asyncpg –±–µ–∑ ORM?
‚úÖ **–®–≤–∏–¥–∫—ñ—Å—Ç—å** - –ø—Ä—è–º—ñ SQL –∑–∞–ø–∏—Ç–∏ –±–µ–∑ overhead
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - dict –∑–∞–º—ñ—Å—Ç—å —Å–∫–ª–∞–¥–Ω–∏—Ö ORM –æ–±'—î–∫—Ç—ñ–≤
‚úÖ **–ö–æ–Ω—Ç—Ä–æ–ª—å** - –ø–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ SQL
‚úÖ **JSON** - –Ω–∞—Ç–∏–≤–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ JSONB PostgreSQL

## üìû –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Pyrogram

### –û—Ç—Ä–∏–º–∞–Ω–Ω—è API_ID —Ç–∞ API_HASH

1. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ https://my.telegram.org
2. –£–≤—ñ–π–¥—ñ—Ç—å –∑ –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω—É
3. API Development tools ‚Üí Create application
4. –°–∫–æ–ø—ñ—é–π—Ç–µ `api_id` —Ç–∞ `api_hash`

### –ü–µ—Ä—à–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è

–ü—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É:
```
Please enter your phone (or bot token): +380123456789
Please enter the code you received: 12345
```

–°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —Ñ–∞–π–ª `caller_session.session` - –∑–±–µ—Ä—ñ–≥–∞–π—Ç–µ –π–æ–≥–æ –≤ –±–µ–∑–ø–µ—Ü—ñ!

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ

- Pyrogram session –¥–æ–∑–≤–æ–ª—è—î **–∑–¥—ñ–π—Å–Ω—é–≤–∞—Ç–∏ –¥–∑–≤—ñ–Ω–∫–∏** –≤—ñ–¥ –≤–∞—à–æ–≥–æ –∞–∫–∞—É–Ω—Ç—É
- **–ù–ï –¥—ñ–ª—ñ—Ç—å—Å—è** session —Ñ–∞–π–ª–æ–º
- –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –æ–∫—Ä–µ–º–∏–π Telegram –∞–∫–∞—É–Ω—Ç –¥–ª—è –¥–∑–≤—ñ–Ω–∫—ñ–≤

## üêõ Troubleshooting

### "Pool not initialized"
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ DATABASE_URL
python -c "from config import config; print(config.DATABASE_URL)"

# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ PostgreSQL
psql -U postgres -d ukz_monitor -c "SELECT 1"
```

### "FloodWait" –ø–æ–º–∏–ª–∫–∞ Pyrogram
Telegram –æ–±–º–µ–∂—É—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥–∑–≤—ñ–Ω–∫—ñ–≤. –ü–æ—á–µ–∫–∞–π—Ç–µ –≤–∫–∞–∑–∞–Ω–∏–π —á–∞—Å.

### API UZ –ø–æ–≤–µ—Ä—Ç–∞—î 441
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –ø—Ä–æ–∫—Å—ñ (–Ω–∞–ª–∞—à—Ç—É–π—Ç–µ `PROXY_ENABLED=true` –≤ `.env`)
- –ó–±—ñ–ª—å—à—Ç–µ `MONITORING_INTERVAL` (–º—ñ–Ω—ñ–º—É–º 600 —Å–µ–∫—É–Ω–¥)
- –û–Ω–æ–≤—ñ—Ç—å headers –≤ `uz_api/client.py`
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ cloudscraper –≤–µ—Ä—Å—ñ—é

## üöÄ –î–µ–ø–ª–æ–π

### –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ systemd (Linux)
```bash
sudo nano /etc/systemd/system/ukz-bot.service
```

```ini
[Unit]
Description=UKZ Train Monitor Bot
After=network.target postgresql.service

[Service]
Type=simple
User=your_user
WorkingDirectory=/path/to/UKZTrainMonitor
Environment="PATH=/path/to/venv/bin"
ExecStart=/path/to/venv/bin/python main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl enable ukz-bot
sudo systemctl start ukz-bot
```

### –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2 (Node.js)
```bash
pm2 start main.py --name ukz-bot --interpreter python3
pm2 save
pm2 startup
```

## üìÑ –õ—ñ—Ü–µ–Ω–∑—ñ—è

MIT
